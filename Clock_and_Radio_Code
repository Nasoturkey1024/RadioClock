# toDo
# implement rotary encoder functionality
# implement frequency search/confirm using rotary encoder
# OLED Display
from machine import Pin, I2C, Timer
import time

# Buttons for clock functionality

enter_save_time = machine.Pin(0, machine.Pin.IN, machine.Pin.PULL_UP) # implemented
switch_time_12and24 = machine.Pin(1, machine.Pin.IN, machine.Pin.PULL_UP) # implemented
enter_save_alarm = machine.Pin(2, machine.Pin.IN, machine.Pin.PULL_UP) # implemented
turn_alarm_off_on = machine.Pin(3, machine.Pin.IN, machine.Pin.PULL_UP) # implemented
snooze = machine.Pin(4, machine.Pin.IN, machine.Pin.PULL_UP) # implemented

# Universal buttons 
value_increase = machine.Pin(5, machine.Pin.IN, machine.Pin.PULL_UP) # implemented, finish clock volume
value_decrease = machine.Pin(6, machine.Pin.IN, machine.Pin.PULL_UP) # implemented, finish clock volume
switch_display = machine.Pin(7, machine.Pin.IN, machine.Pin.PULL_UP) # button implemented

# Radio button/dial
radio_on_off = machine.Pin(8, machine.Pin.IN, machine.Pin.PULL_UP) # implemented, needs testing
dial_button = machine.Pin(13, machine.Pin.IN, machine.Pin.PULL_UP)
rotaryA = machine.Pin(15 machine.Pin.IN, machine.Pin.PULL_UP)
rotaryB = machine.Pin(14, machine.Pin.IN, machine.Pin.PULL_UP)

# mode decides what the universal increament/decreament do as well as display
mode = 1
# timer for use with debouncing
tim = machine.Timer()
clock_tim = machine.Timer()
# timer for use with clock

# use this to change mode and implement changes that result from change
def change_mode(t):
    if t > 6 or t < 1:
        t = 1
    if t == 1: # clock mode
        mode = 1
    elif t == 2: # edit clock hour mode
        mode = 2
    elif t == 3: # edit clock minute mode
        mode = 3
    elif t == 4: # edit alarm hour mode
        mode = 4
    elif t == 5: # edit alarm minute mode
        mode = 5
    else: # radio mode
        mode = 6
# increament value of volume/number depending on current mode
def switch_clock_radio_display():
    if switch_display.value() == 0:
        if mode == 6:
            change_mode(1)
        else:
            change_mode(6)
# goes from hour->minute alarm edit
def enter_alarm_edit():
    if enter_save_alarm.value() == 0:
        if mode == 4:
            change_mode(5) # enter alarm minute
        elif mode == 5:
            change_mode(1) # exit alarm edit
        else:
            change_mode(4) # enter alarm hour
def toggle_alarm():
    if turn_alarm_off_on.value() == 0:
        clock.toggle_alarm()
def snooze_alarm():
    if snooze.value() == 0:
        clock.snooze()
def increament():
    if increament.value() == 0:
        if mode == 1: # clock mode, 
            clock.increament_volume()
        elif mode == 2: # edit clock hour
            clock.increament_hour()
        elif mode == 3: # edit clock minute
            clock.increament_minute()
        elif mode == 4: # edit alarm hour
            clock.increament_alarm_hour()
        elif mode == 5: # edit alarm minute
            clock.increament_alarm_minute()
        else:
            Settings = fm_radio.GetSettings()
            Volume = Settings[1] + 1
            if(Volume == 16):
                Volume = 15
            if ( fm_radio.SetVolume( Volume ) == True ):
                fm_radio.ProgramRadio()
       
# decreament value of volume/number depending on current mode 
def decreament():
    if value_decrease.value() == 0:
        if mode == 1:# clock mode
            clock.decreament_volume()
        elif mode == 2: # edit clock hour
            clock.decreament_hour()
        elif mode == 3: # edit clock minute
            clock.decreament_minute()
        elif mode == 4: # edit alarm hour
            clock.decreament_alarm_hour()
        elif mode == 5: # edit alarm minute
            clock.decreament_alarm_minute()
        else: # radio mode
            Settings = fm_radio.GetSettings()
            Volume = Settings[1] - 1
            if(Volume < 0):
                Volume = 0
            if ( fm_radio.SetVolume( Volume ) == True ):
                fm_radio.ProgramRadio()

def enter_save():
    if enter_save_time.value() == 0:
        if mode == 2:
            change_mode(3)
        elif mode == 3:
            change_mode(1)
        else:
            change_mode(2)
            
def switch_display_time():
    if switch_time_12and24.value() == 0:
        if clock.display == 0:
            clock.display = 1
        else:
            clock.display

def turn_radio_off_on():
    if radio_on_off.value == 0:
        if fm_radio.Mute == False:
            fm_radio.SetMute(True)
            fm_radio.ProgramRadio()
        else:
            fm_radio.SetMute(False)
            fm_radio.ProgramRadio()
    
# debounces universal increament
def increament_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=increament)
# debounces universal decreament
def decreament_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=decreament)
# debounces enter/save time for clock
def enter_save_time_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=enter_save)

# debounces for all clock buttons
def switch_time_12and24_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=clock.change_display)
def switch_display_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=switch_clock_radio_display)
def enter_alarm_edit_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=enter_alarm_edit)
def toggle_alarm_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=toggle_alarm)
def snooze_alarm_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=snooze_alarm)

def toggle_radio_off_on_debounce(t):
    tim.init(freq=50, mode=Timer.ONE_SHOT, callback=turn_radio_off_on)

# interrupt handlers for all buttons
value_increase.irq(trigger=machine.Pin.IRQ_Falling or machine.Pin.IRQ_Rising, handler=increament_debounce)
value_decrease.irq(trigger=machine.Pin.IRQ_Falling or machine.Pin.IRQ_Rising, handler=decreament_debounce)
enter_save_time.irq(trigger=machine.Pin.IRQ_Falling or machine.Pin.IRQ_Rising, handler=enter_save_time_debounce)
switch_time_12and24.irq(trigger=machine.Pin.IRQ_FALLING or machine.Pin.IRQ_Rising, handler=switch_time_12and24_debounce)
switch_display.irq(trigger=machine.Pin.IRQ_FALLING or machine.Pin.IRQ_RISING, handler=switch_display_debounce)
enter_save_alarm.irq(trigger=machine.Pin.IRQ_FALLING or machine.Pin.IRQ_RISING, handler=enter_alarm_edit_debounce)
turn_alarm_off_on.irq(trigger=machine.Pin.IRQ_FALLING or machine.Pin.IRQ_RISING, handler=toggle_alarm_debounce)
snooze.irq(trigger=machine.Pin.IRQ_FALLING or machine.Pin.IRQ_RISING, handler=snooze_alarm_debounce)

radio_on_off.irq(trigger=machine.Pin.IRQ_FALLING or machine.Pin.IRQ_RISING, handler=toggle_radio_off_on_debounce)

class Clock:
    
    def __init__(self):
        
        self.hour = 0 # current hour 
        self.minute = 0 # current minute
        self.display = False # sets clock as 12 hour time

        self.alarm_hour = 7
        self.alarm_minute = 30
        self.alarm_volume = 10

        self.alarm_set = False
        self.alarm_ringing = False

    def change_display(self):
        self.display = not(self.display)
    # increament and decreament hour for clock purposes
    def increament_hour(self):
        if self.hour >= 23:
            self.hour = 0
        else:
            self.hour = self.hour + 1
    def decreament_hour(self):
        if self.hour <= 0:
            self.hour = 23
        else:
            self.hour = self.hour - 1
    # increament and decreament minute for clock purposes
    def increament_minute(self):
        if self.minute >= 59:
            self.minute = 0
        else:
            self.minute = self.minute + 1
    def decreament_minute(self):
        if self.minute <= 0:
            self.minute = 59
        else:
            self.minute = self.minute - 1
    # increaments and decreaments hour for alarm
    def increament_alarm_hour(self):
        if self.alarm_hour == 23:
            self.alarm_hour = 0
        else:
            self.alarm_hour = self.alarm_hour + 1
    def decreament_alarm_hour(self):
        if self.alarm_hour == 0:
            self.alarm_hour = 23
        else:
            self.alarm_hour = self.alarm_hour - 1
    # increaments alarm minute, has t variable for use of snooze button
    def increament_alarm_minute(self, t):
        if self.alarm_minute + t >= 60:
            self.alarm_minute = self.alarm.minute + t - 60
            self.increament_alarm_hour()
        else:
            self.alarm_minute = self.alarm_minute + t - 60
    # decreaments alarm
    def decreament_alarm_minute(self):
        if self.alarm_minute <= 0:
            self.alarm_minute = 59
        else:
            self.alarm_minute = self.alarm_minute - 1
    # toggles alarm set/not set
    def toggle_alarm(self):
        if self.alarm_ringing == True:
            self.alarm_ringing = False
            self.alarm_set = False
        else:
            self.alarm_set = not(self.alarm_set)
    # snoozes alarm if it is ringing
    def snooze(self):
        if self.alarm_ringing == True:
            self.alarm_ringing = False
            self.alarm
    # keep simple until max/min values of volume discovered
    def increament_volume(self):
        self.volume += 1
    def decreament_volume(self):
        self.volume -= 1
    # increament minute for clock timer only
    def increase_minute(self):
        if self.minute >= 59:
            self.minute = 0
            self.increament_hour()
        else:
            self.minute = self.minute + 1
    # clock timer that increases minute every minute
    clock_tim.init(period = 60, mode=Timer.PERIODIC, callback=increase_minute)


        

class Radio:
    
    def __init__( self, NewFrequency, NewVolume, NewMute ):

#
# set the initial values of the radio
#
        self.Volume = 2
        self.Frequency = 88
        self.Mute = False
        
#
# Update the values with the ones passed in the initialization code
#
        self.SetVolume( NewVolume )
        self.SetFrequency( NewFrequency )
        self.SetMute( NewMute )
        
      
# Initialize I/O pins associated with the radio's I2C interface

        self.i2c_sda = Pin(26)
        self.i2c_scl = Pin(27)

#
# I2C Device ID can be 0 or 1. It must match the wiring. 
#
# The radio is connected to device number 1 of the I2C device
#
        self.i2c_device = 1 
        self.i2c_device_address = 0x10

#
# Array used to configure the radio
#
        self.Settings = bytearray( 8 )


        self.radio_i2c = I2C( self.i2c_device, scl=self.i2c_scl, sda=self.i2c_sda, freq=200000)
        self.ProgramRadio()

    def SetVolume( self, NewVolume ):
#
# Conver t the string into a integer
#
        try:
            NewVolume = int( NewVolume )
            
        except:
            return( False )
        
#
# Validate the type and range check the volume
#
        if ( not isinstance( NewVolume, int )):
            return( False )
        
        if (( NewVolume < 0 ) or ( NewVolume >= 16 )):
            return( False )

        self.Volume = NewVolume
        return( True )



    def SetFrequency( self, NewFrequency ):
#
# Convert the string into a floating point value
#
        try:
            NewFrequency = float( NewFrequency )
            
        except:
            return( False )
#
# validate the type and range check the frequency
#
        if ( not ( isinstance( NewFrequency, float ))):
            return( False )
 
        if (( NewFrequency < 88.0 ) or ( NewFrequency > 108.0 )):
            return( False )

        self.Frequency = NewFrequency
        return( True )
        
    def SetMute( self, NewMute ):
        
        try:
            self.Mute = bool( int( NewMute ))
            
        except:
            return( False )
        
        return( True )

#
# convert the frequency to 10 bit value for the radio chip
#
    def ComputeChannelSetting( self, Frequency ):
        Frequency = int( Frequency * 10 ) - 870
        
        ByteCode = bytearray( 2 )
#
# split the 10 bits into 2 bytes
#
        ByteCode[0] = ( Frequency >> 2 ) & 0xFF
        ByteCode[1] = (( Frequency & 0x03 ) << 6 ) & 0xC0
        return( ByteCode )

#
# Configure the settings array with the mute, frequency and volume settings
#
    def UpdateSettings( self ):
        
        if ( self.Mute ):
            self.Settings[0] = 0x80
        else:
            self.Settings[0] = 0xC0
  
        self.Settings[1] = 0x09 | 0x04
        self.Settings[2:3] = self.ComputeChannelSetting( self.Frequency )
        self.Settings[3] = self.Settings[3] | 0x10
        self.Settings[4] = 0x04
        self.Settings[5] = 0x00
        self.Settings[6] = 0x84
        self.Settings[7] = 0x80 + self.Volume

#        
# Update the settings array and transmitt it to the radio
#
    def ProgramRadio( self ):

        self.UpdateSettings()
        self.radio_i2c.writeto( self.i2c_device_address, self.Settings )

#
# Extract the settings from the radio registers
#
    def GetSettings( self ):
#        
# Need to read the entire register space. This is allow access to the mute and volume settings
# After and address of 255 the 
#
        self.RadioStatus = self.radio_i2c.readfrom( self.i2c_device_address, 256 )

        if (( self.RadioStatus[0xF0] & 0x40 ) != 0x00 ):
            MuteStatus = False
        else:
            MuteStatus = True
            
        VolumeStatus = self.RadioStatus[0xF7] & 0x0F
 
 #
 # Convert the frequency 10 bit count into actual frequency in Mhz
 #
        FrequencyStatus = (( self.RadioStatus[0x00] & 0x03 ) << 8 ) | ( self.RadioStatus[0x01] & 0xFF )
        FrequencyStatus = ( FrequencyStatus * 0.1 ) + 87.0
        
        if (( self.RadioStatus[0x00] & 0x04 ) != 0x00 ):
            StereoStatus = True
        else:
            StereoStatus = False
        
        return( MuteStatus, VolumeStatus, FrequencyStatus, StereoStatus )

#
# initialize the FM radio
#
fm_radio = Radio( 101.9, 2, False )
clock = Clock()

while ( True ):

#
# display the menu
#
    
    print("")
    print( "ECE 299 FM Radio Demo Menu" );
    print("")
    print( "1 - change radio frequency" )
    print( "2 - change volume level" )
    print( "3 - mute audio" )
    print( "4 - read current settings" )
    
    select = input( "Enter menu number > " )

#
# Set radio frequency
#
    if ( select == "1" ):
        Frequency = input( "Enter frequncy in Mhz ( IE 100.3 ) > " )

        if ( fm_radio.SetFrequency( Frequency ) == True ):
            fm_radio.ProgramRadio()
        else:
            print( "Invalid frequency( Range is 88.0 to 108.0 )" )

#
# Set volume level of radio
#
    elif ( select == "2" ):
        Volume = input( "Enter volume level ( 0 to 15, 15 is loud ) > " )
        
        if ( fm_radio.SetVolume( Volume ) == True ):
            fm_radio.ProgramRadio()
        else:
            print( "Invalid volume level( Range is 0 to 15 )" )
        
#        
# Enable mute of radio       
#        
    elif( select == "3" ):
        Mute = input( "Enter mute ( 1 for Mute, 0 for audio ) > " )
        
        if ( fm_radio.SetMute( Mute ) == True ):
            fm_radio.ProgramRadio()
        else:
            print( "Invalid mute setting" )

#
# Display radio current settings
#
    elif( select == "4" ):
        Settings = fm_radio.GetSettings()

        print( Settings )
        print("")
        print("Radio Status")
        print("")

        print( "Mute: ", end="" )
        if ( Settings[0] == True ):
            print( "enabled" )
        else:
            print( "disabled" )

        print( "Volume: %d" % Settings[1] )

        print( "Frequency: %5.1f" % Settings[2] )

        print( "Mode: ", end="" )
        if ( Settings[3] == True ):
            print( "stereo" )
        else:
            print( "mono" )


    else:
        print( "Invalid menu option" )

        


